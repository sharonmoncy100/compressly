<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Disable GA on localhost -->
    <script>
        if (location.hostname === "localhost") {
            window['ga-disable-G-K9Z1H2JLZQ'] = true;
        }
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K9Z1H2JLZQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-K9Z1H2JLZQ', { anonymize_ip: true });
        gtag('event', 'psc_tool_opened', { page: 'psc-photo-tool' });
    </script>

    <title>Kerala PSC Photo Preparation Tool â€“ Resize & Compress | Compressly</title>

    <meta name="description"
        content="Prepare your Kerala PSC (KPSC Thulasi) photo with exact pixel size, proper name & date stamp, and accurate 30 KB or 100 KB compression. Works fully in your browser." />

    <link rel="canonical" href="https://www.compressly.in/psc-photo-tool.html" />

    <style>
        * {
            box-sizing: border-box
        }

        :root {
            --fg: #0f1724;
            --muted: #475569;
            --accent: #2563eb;
            --bg: #f8fafc;
            --card: #fff;
            --border: rgba(15, 23, 42, .08);
            font-family: Inter, system-ui, Arial, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 14px 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--fg);
            font-weight: 700;
        }

        main {
            flex: 1
        }

        .wrap {
            max-width: 1040px;
            margin: 0 auto;
            padding: 16px
        }

        .breadcrumb {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 12px
        }

        .breadcrumb a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500
        }

        .breadcrumb span {
            margin: 0 6px;
            color: #94a3b8
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
        }

        h1 {
            font-size: 26px;
            margin: 0 0 6px
        }

        h2 {
            font-size: 20px;
            margin: 0 0 8px
        }

        .trust {
            font-size: 14px;
            color: var(--muted)
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            display: block
        }

        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 11px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
        }

        .file-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border-radius: 10px;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, .25);
        }

        input[type="file"] {
            display: none
        }

            .file-name{
        margin-top:6px;font-size:13px;color:var(--muted);
        transition:all 0.3s ease;
        }
        .file-name.selected{
        color:var(--fg);
        font-weight:600;
        background:#e0f2fe;
        padding:8px 12px;
        border-radius:6px;
        border-left:3px solid #2563eb;
        }

        .row {
            display: flex;
            gap: 14px
        }

        .row>div {
            flex: 1
        }

        @media(max-width:640px) {
            .row {
                flex-direction: column
            }

            .btn-primary {
                max-width: none
            }
        }

        .small-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 2px
        }

        .preset-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 6px
        }

        .preset {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            cursor: pointer;
            font-size: 13px
        }

        .preset.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .toggle {
            font-size: 14px;
            color: var(--accent);
            cursor: pointer;
            margin-top: 10px;
            display: inline-block
        }

        .btn-primary {
            margin: 18px auto 0;
            display: block;
            width: 100%;
            max-width: 360px;
            padding: 13px;
            font-size: 15px;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn-primary:disabled {
            opacity: .5
        }

        .processing {
            margin-top: 10px;
            font-size: 13px;
            color: var(--accent);
            display: none;
            text-align: center
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin .6s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .result {
            text-align: center;
            display: none
        }

        .preview {
            max-width: 170px;
            margin: 14px auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            image-rendering: crisp-edges;
        }

        footer {
            text-align: center;
            font-size: 13px;
            color: var(--muted);
            padding: 18px 0;
            border-top: 1px solid var(--border);
            background: #fff;
        }

        /* ===== CROP UI ===== */
        .crop-container {
            display: none;
            margin-top: 16px
        }

       .crop-wrapper {
    background: #f1f5f9;
    border-radius: 12px;
    padding: 24px;              /* â¬… more space */
    text-align: center;
    position: relative;
    overflow: hidden;
}

    .crop-canvas-wrap {
    position: relative;
    display: inline-block;
    max-width: 100%;
    background: #ffffff;        /* â¬… real photo background */
    border-radius: 8px;
    padding: 0px;              /* â¬… makes crop box feel inside */
    box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
}
 #cropCanvas {
    max-width: 100%;
    border-radius: 6px;
    display: block;
    background: #ffffff;
}

.crop-box {
    position: absolute;
    border: 2px solid #2563eb;
    background: transparent;
    cursor: move;
    z-index: 5;
    touch-action: none;
}

        .crop-box-content {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .crop-hint {
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
            font-weight: 500
        }

        .zoom-control {
            margin: 12px auto;
            max-width: 300px;
        }

        .zoom-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
            text-align: center;
        }

        .zoom-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }

        .zoom-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }

        .crop-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 14px;
            flex-wrap: wrap
        }

        .crop-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none
        }

        .crop-btn-primary {
            background: #2563eb;
            color: #fff
        }

        .crop-btn-secondary {
            background: #e5e7eb;
            color: #374151
        }

        .promo {
            background: #f1f5f9;
            text-align: center
        }
    </style>
</head>

<body>

    <header>
        <a href="/" class="brand">
            <img src="/icon.png" width="32" height="32" alt="Compressly logo">
            <span>Compressly</span>
        </a>
    </header>

    <main>
        <div class="wrap">

            <nav class="breadcrumb">
                <a href="/">Home</a><span>â€º</span><span>Kerala PSC Photo Tool</span>
            </nav>

            <div class="card">
                <h1>Kerala PSC Photo Preparation Tool</h1>
                <div class="trust">
                    Prepare your Kerala PSC (KPSC Thulasi) photo exactly as required. Resize to official dimensions, add
                    a clean name and date stamp, and compress to the correct file size - all securely in your browser.
                </div>
            </div>

    <div class="card">
        <!-- âœ… STEP 1: Choose type FIRST -->
    <div style="margin-bottom:20px">
        <label>What do you want to prepare?</label>
        <div class="preset-row">
            <div class="preset active photo-type" data-type="photo" data-w="150" data-h="200">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
                    style="vertical-align:-2px;margin-right:4px">
                    <path
                        d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                </svg>
                Photo (150Ã—200)
            </div>
            <div class="preset photo-type" data-type="signature" data-w="150" data-h="100">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
                    style="vertical-align:-2px;margin-right:4px">
                    <path
                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                </svg>
                Signature (150Ã—100)
            </div>
        </div>
        <div class="small-label" style="margin-top:6px" id="typeHint">
            Standard passport-size photo for PSC applications
        </div>
    </div>
    
        <!-- âœ… STEP 2: Upload -->
        <div id="uploadSection">
            <label id="uploadLabel">Upload your <span id="uploadTypeLabel">photo</span></label>
            <label class="file-btn" id="chooseBtn">
                Choose <span id="btnTypeLabel">photo</span>
                <input type="file" id="fileInput" accept="image/*">
            </label>
        </div>
        <div id="fileName" class="file-name"></div>
                <!-- CROP UI -->
                <div class="crop-container" id="cropContainer">
                <div class="crop-hint" id="cropHint">
                    Adjust your photo (150Ã—200 ratio) â€¢ Drag the box to reposition
                </div>

                    <div class="crop-wrapper">
                        <div class="crop-canvas-wrap" id="cropCanvasWrap">
                            <canvas id="cropCanvas"></canvas>
                           

                            <div class="crop-box" id="cropBox">
                                
                            </div>
                        </div>
                    </div>

                    <div class="zoom-control">
                        <div class="zoom-label">Zoom</div>
                        <input type="range" class="zoom-slider" id="zoomRange" min="0.5" max="2.5" step="0.01" value="0.8">
                    </div>

                    <div class="crop-actions">
                        <button class="crop-btn crop-btn-secondary" id="skipCrop">Skip crop</button>
                        <button class="crop-btn crop-btn-primary" id="applyCrop">Use this crop</button>
                    </div>
                </div>

                <!-- MAIN CONTROLS -->
                <div id="mainControls">

                    <div style="margin-top:16px">
                        <label>Photo dimensions</label>
                        <div class="row">
                            <div>
                                <div class="small-label">Width (px)</div>
                                <input type="number" id="width" value="150">
                            </div>
                            <div>
                                <div class="small-label">Height (px)</div>
                                <input type="number" id="height" value="200">
                            </div>
                        </div>
                    </div>

              
                
                <div style="margin-top:16px">
                    <label>Target file size</label>
                    <div class="preset-row">
                        <div class="preset active file-size" data-kb="30">30 KB (PSC)</div>
                        <div class="preset file-size" data-kb="100">100 KB</div>
                    </div>
                </div>

                    <div class="toggle" id="toggleStamp">+ Add name & date stamp (optional)</div>

                    <div id="stampFields" style="display:none;margin-top:14px">
                        <div class="row">
                            <div>
                                <label>Name</label>
                                <input type="text" id="stampName">
                            </div>
                            <div>
                                <label>Date</label>
                                <input type="date" id="stampDate">
                            </div>
                        </div>
                        <div class="small-label" style="margin-top:6px">Date appears as DD-MM-YYYY</div>
                    </div>

                    <button id="processBtn" class="btn-primary" disabled>Prepare PSC Photo</button>
                    <div class="processing" id="processing">
                        <span class="spinner"></span>Processing your photoâ€¦
                    </div>

                </div>
            </div>

            <div class="card result" id="resultCard">
                <h2>Your PSC photo is ready</h2>
                <img id="preview" class="preview">
                <div id="meta" class="trust"></div>
                <a id="download" style="text-decoration:none">
                    <button class="btn-primary">Download Photo</button>
                </a>
            </div>

            <div class="card">
                <h2>PSC Photo Requirements Explained</h2>
                <p class="trust">
                    Kerala PSC applications require photos to meet strict pixel and file-size rules. Images outside the
                    allowed range may be rejected by the Thulasi portal.
                </p>
                <p class="trust">
                    This tool prepares photos using commonly accepted PSC standards such as 150Ã—200 pixels and a 30 KB
                    file size.
                </p>
                <p class="trust">
                    All processing happens locally in your browser. Your image is never uploaded or stored.
                </p>
            </div>

            <div class="card promo">
                <p class="trust">Need to compress other images or formats?</p>
                <a href="/" style="color:#2563eb;font-weight:600;text-decoration:none">
                    Go to Compressly Image Compressor â†’
                </a>
            </div>

        </div>
    </main>

    <footer>
        Â© 2026 Compressly Â· <a href="/privacy.html">Privacy</a> Â· <a href="/terms.html">Terms</a>
    </footer>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const cropContainer = document.getElementById('cropContainer');
        const cropCanvas = document.getElementById('cropCanvas');
        const cropBoxCanvas = document.getElementById('cropBoxCanvas');
        const cropCanvasWrap = document.getElementById('cropCanvasWrap');
        const cropBox = document.getElementById('cropBox');
        const applyCrop = document.getElementById('applyCrop');
        const skipCrop = document.getElementById('skipCrop');
        const zoomRange = document.getElementById('zoomRange');
        const mainControls = document.getElementById('mainControls');
        const processBtn = document.getElementById('processBtn');
        const processing = document.getElementById('processing');
        const preview = document.getElementById('preview');
        const download = document.getElementById('download');
        const meta = document.getElementById('meta');
        const presets = document.querySelectorAll('.preset');
        const toggleStamp = document.getElementById('toggleStamp');
        const stampFields = document.getElementById('stampFields');
        const stampName = document.getElementById('stampName');
        const stampDate = document.getElementById('stampDate');
        const uploadSection = document.getElementById('uploadSection');
            const chooseBtn = document.getElementById('chooseBtn');
            const uploadLabel = document.getElementById('uploadLabel');

        let originalImage = null, croppedImage = null;
            let zoom = 0.8, targetKB = 30, stampEnabled = false;
            let canvasWidth = 0, canvasHeight = 0, imageOffsetX = 0, imageOffsetY = 0;
            let selectedFileName = '';
            let photoType = 'photo'; // 'photo' or 'signature'
            let targetWidth = 150, targetHeight = 200; // Default photo dimensions

        stampDate.valueAsDate = new Date();

      // File size presets
        document.querySelectorAll('.preset.file-size').forEach(p => {
            p.onclick = () => {
                document.querySelectorAll('.preset.file-size').forEach(x => x.classList.remove('active'));
                p.classList.add('active');
                targetKB = +p.dataset.kb;
            }
        });

       // Photo type presets
        document.querySelectorAll('.preset.photo-type').forEach(p => {
            p.onclick = () => {
                document.querySelectorAll('.preset.photo-type').forEach(x => x.classList.remove('active'));
                p.classList.add('active');
                photoType = p.dataset.type;
                targetWidth = +p.dataset.w;
                targetHeight = +p.dataset.h;

                // Update dimension inputs
                document.getElementById('width').value = targetWidth;
                document.getElementById('height').value = targetHeight;

                // âœ… UPDATE UI LABELS dynamically
                const isSignature = photoType === 'signature';
                document.getElementById('uploadTypeLabel').textContent = isSignature ? 'signature' : 'photo';
                document.getElementById('btnTypeLabel').textContent = isSignature ? 'signature' : 'photo';
                document.getElementById('typeHint').textContent = isSignature
                    ? 'Your handwritten signature on white paper (black/blue pen)'
                    : 'Standard passport-size photo for PSC applications';

                // Update crop hint text
                updateCropHintText();

                // If crop is showing, update crop box aspect ratio
                if (cropContainer.style.display === 'block' && originalImage) {
                    updateCropBoxAspect();
                }
            }
        });

        toggleStamp.onclick = () => {
            stampEnabled = !stampEnabled;
            stampFields.style.display = stampEnabled ? 'block' : 'none';
            toggleStamp.textContent = stampEnabled ? '- Remove name & date stamp' : '+ Add name & date stamp (optional)';
        };

 fileInput.onchange = async () => {
        if (!fileInput.files.length) return;

        selectedFileName = fileInput.files[0].name;
        uploadSection.style.display = 'none';

        fileNameEl.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24"
             xmlns="http://www.w3.org/2000/svg"
             style="vertical-align:-2px;margin-right:6px;fill:#2563eb">
          <path d="M3 6c0-1.1.9-2 2-2h4l2 2h8c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V6z"/>
        </svg>
        ${selectedFileName} <span style="color:#2563eb">(loading...)</span>
    `;
        fileNameEl.classList.add('selected');

        const img = new Image();
        const objectUrl = URL.createObjectURL(fileInput.files[0]);

        img.onload = async () => {
            URL.revokeObjectURL(objectUrl);

            // âœ… DOWNSAMPLE for mobile camera photos
            const maxDimension = 1600;
            if (img.width > maxDimension || img.height > maxDimension) {
                try {
                    originalImage = await downsampleLargeImage(img, maxDimension);
                } catch (e) {
                    originalImage = img;
                }
            } else {
                originalImage = img;
            }

            // Remove loading text
            fileNameEl.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg"
                 style="vertical-align:-2px;margin-right:6px;fill:#2563eb">
              <path d="M3 6c0-1.1.9-2 2-2h4l2 2h8c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V6z"/>
            </svg>
            ${selectedFileName}
        `;

            processBtn.disabled = false;
            showCrop(originalImage);
        };

        img.src = objectUrl;
        fileInput.value = '';
    };

  async function downsampleLargeImage(img, maxDim) {
        return new Promise((resolve) => {
            let w = img.width;
            let h = img.height;

            const scale = Math.min(maxDim / w, maxDim / h, 1);
            w = Math.round(w * scale);
            h = Math.round(h * scale);

            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            const ctx = c.getContext('2d');

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, w, h);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, w, h);

            c.toBlob((blob) => {
                const newImg = new Image();
                newImg.onload = () => resolve(newImg);
                newImg.src = URL.createObjectURL(blob);
            }, 'image/jpeg', 0.98); // âœ… CHANGED from 0.92 to 0.98
        });
    }
        function showCrop(img) {
            const aspect = targetWidth / targetHeight; // âœ… Use current target dimensions
            const maxBoxScale = 0.72;      // âœ… ADD THIS LINE
            cropContainer.style.display = 'block';
            updateCropHintText(); // âœ… ADD THIS LINE
            mainControls.style.display = 'none';
            const maxW = Math.min(600, window.innerWidth - 80);
            const imgAspect = img.width / img.height;
            let canvasW = maxW;
            let canvasH = canvasW / imgAspect;

            if (canvasH > 400) {
                canvasH = 400;
                canvasW = canvasH * imgAspect;
            }

            canvasWidth = canvasW;
            canvasHeight = canvasH;

            cropCanvas.width = canvasW;
            cropCanvas.height = canvasH;

            const ctx = cropCanvas.getContext('2d');
           

            function redraw() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                const dw = canvasWidth * zoom;
                const dh = canvasHeight * zoom;

                imageOffsetX = (canvasWidth - dw) / 2;
                imageOffsetY = (canvasHeight - dh) / 2;

                ctx.drawImage(img, imageOffsetX, imageOffsetY, dw, dh);

                // Clamp crop box safely (desktop + mobile)
                const maxL = canvasWidth - cropBox.offsetWidth;
                const maxT = canvasHeight - cropBox.offsetHeight;

                cropBox.style.left =
                    Math.max(0, Math.min(parseFloat(cropBox.style.left), maxL)) + 'px';
                cropBox.style.top =
                    Math.max(0, Math.min(parseFloat(cropBox.style.top), maxT)) + 'px';
            }
           


            redraw();

            zoomRange.oninput = e => { zoom = +e.target.value; redraw(); };

         // PSC-friendly crop box (slightly smaller to allow free movement)
            
          // Use updateCropBoxAspect function
            updateCropBoxAspect();

            enableDrag(redraw);
        }

        function enableDrag(redrawCallback) 
        {
            let dragging = false, sx, sy, sl, st;
            cropBox.onmousedown = cropBox.ontouchstart = e => {
                e.preventDefault();
                dragging = true;
                const touch = e.touches ? e.touches[0] : e;
                sx = touch.clientX; sy = touch.clientY;
                sl = parseFloat(cropBox.style.left);
                st = parseFloat(cropBox.style.top);
            };
            const move = e => {
                if (!dragging) return;
                const touch = e.touches ? e.touches[0] : e;
                let l = sl + (touch.clientX - sx);
                let t = st + (touch.clientY - sy);
                l = Math.max(0, Math.min(l, canvasWidth - cropBox.offsetWidth));
                t = Math.max(0, Math.min(t, canvasHeight - cropBox.offsetHeight));
                cropBox.style.left = l + 'px';
                cropBox.style.top = t + 'px';
                redrawCallback();
            };
            const end = () => dragging = false;
            document.addEventListener('mousemove', move);
            document.addEventListener('touchmove', move);
            document.addEventListener('mouseup', end);
            document.addEventListener('touchend', end);
        }
        // âœ… UPDATE CROP BOX SIZE BASED ON SELECTED PHOTO TYPE 
        function updateCropBoxAspect() {
                const aspect = targetWidth / targetHeight;
                const maxBoxScale = 0.72;

                let bw, bh;
                if (canvasWidth / canvasHeight > aspect) {
                    bh = canvasHeight * maxBoxScale;
                    bw = bh * aspect;
                } else {
                    bw = canvasWidth * maxBoxScale;
                    bh = bw / aspect;
                }

                cropBox.style.width = bw + 'px';
                cropBox.style.height = bh + 'px';
                cropBox.style.left = (canvasWidth - bw) / 2 + 'px';
                cropBox.style.top = (canvasHeight - bh) / 2 + 'px';
            }
            // âœ… Update crop ends

              function updateCropHintText() {
                    const cropHint = document.getElementById('cropHint');
                    if (photoType === 'signature') {
                        cropHint.textContent = 'Adjust your signature (150Ã—100 ratio) â€¢ Drag the box to reposition';
                    } else {
                        cropHint.textContent = 'Adjust your photo (150Ã—200 ratio) â€¢ Drag the box to reposition';
                    }
                }

        applyCrop.onclick = () => {
            mainControls.style.display = 'block';
          const rect = cropCanvas.getBoundingClientRect();

            // how much CSS is scaling the canvas
            const scaleCanvasX = canvasWidth / rect.width;
            const scaleCanvasY = canvasHeight / rect.height;

            const scaleX = originalImage.width / (canvasWidth * zoom);
            const scaleY = originalImage.height / (canvasHeight * zoom);

            const boxL = parseFloat(cropBox.style.left) * scaleCanvasX;
            const boxT = parseFloat(cropBox.style.top) * scaleCanvasY;
            const boxW = parseFloat(cropBox.style.width) * scaleCanvasX;
            const boxH = parseFloat(cropBox.style.height) * scaleCanvasY;

            const sx = (boxL - imageOffsetX) * scaleX;
            const sy = (boxT - imageOffsetY) * scaleY;
            const sw = boxW * scaleX;
            const sh = boxH * scaleY;

            const c = document.createElement('canvas');
            c.width = sw;
            c.height = sh;
           const ctx = c.getContext('2d');

            /* ðŸ”’ FORCE WHITE BACKGROUND (PSC SAFE) */
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, c.width, c.height);

            ctx.drawImage(originalImage, sx, sy, sw, sh, 0, 0, sw, sh);

            const img = new Image();
            img.onload = () => {
                croppedImage = img;
                cropContainer.style.display = 'none';
                mainControls.style.display = 'block';
                uploadSection.style.display = 'block';
                zoom = 0.8;
                zoomRange.value = 0.8;
                fileNameEl.textContent = 'âœ… ' + selectedFileName + ' (cropped)';
            };
            // âœ… USE PNG to preserve quality until final export
            img.src = c.toDataURL('image/png');
        };

     skipCrop.onclick = () => {
     mainControls.style.display = 'block';
            croppedImage = originalImage;
            cropContainer.style.display = 'none';
            mainControls.style.display = 'block';
            uploadSection.style.display = 'block'; // ðŸ‘ˆ SHOW upload UI for potential second try
            zoom = 0.8;
            zoomRange.value = 0.8;
           fileNameEl.textContent = 'âœ… ' + selectedFileName + ' (original - no crop)';
        };

        function stepDownResize(img, w, h) {
            let c = document.createElement('canvas'), ctx = c.getContext('2d');
            c.width = img.width; c.height = img.height; ctx.drawImage(img, 0, 0);
            while (c.width * 0.5 > w) {
                let t = document.createElement('canvas');
                t.width = Math.max(w, Math.round(c.width * 0.5));
                t.height = Math.max(h, Math.round(c.height * 0.5));
                const tCtx = t.getContext('2d');
                tCtx.imageSmoothingEnabled = true;
                tCtx.imageSmoothingQuality = 'high';
                tCtx.drawImage(c, 0, 0, t.width, t.height);
                c = t; ctx = tCtx;
            }
            let f = document.createElement('canvas');
            f.width = w; f.height = h;
            const fCtx = f.getContext('2d');
           fCtx.imageSmoothingEnabled = true;
            fCtx.imageSmoothingQuality = 'high';
            fCtx.fillStyle = '#ffffff';          // âœ… FIX
            fCtx.fillRect(0, 0, w, h);            // âœ… FIX
            fCtx.drawImage(c, 0, 0, w, h);

            return f;
        }

   function applyEdgeSharpen(ctx, w, h) {
        const imgData = ctx.getImageData(0, 0, w, h);
        const data = imgData.data;
        const copy = new Uint8ClampedArray(data);

        // âœ… ADAPTIVE sharpening: stronger for signatures (smaller height)
        let strength = 0.45;
        if (photoType === 'signature') {
            strength = 0.65; // Extra sharp for tiny signatures
        }

        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                const i = (y * w + x) * 4;
                for (let c = 0; c < 3; c++) {
                    const current = copy[i + c];
                    const avg = (copy[i + c - 4] + copy[i + c + 4] +
                        copy[i + c - w * 4] + copy[i + c + w * 4]) / 4;
                    let val = current + (current - avg) * strength;
                    data[i + c] = Math.max(0, Math.min(255, val));
                }
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }

   async function compressToTarget(canvas, minKB, maxKB) {
        // âœ… SIGNATURE-SPECIFIC: Start with higher quality baseline
        let qLow, qHigh;
        if (photoType === 'signature') {
            qLow = 0.94;  // Much higher starting point for signatures
            qHigh = 0.99;
        } else {
            qLow = 0.88;
            qHigh = 0.99;
        }

        let best = null;

        for (let i = 0; i < 15; i++) {
            const q = (qLow + qHigh) / 2;
            const b = await new Promise(r => canvas.toBlob(r, 'image/jpeg', q));
            const kb = b.size / 1024;

            if (kb >= minKB && kb <= maxKB) {
                best = b;
                qLow = q; // Keep searching for better quality
            } else if (kb > maxKB) {
                qHigh = q;
            } else {
                qLow = q;
            }
        }

        return best || await new Promise(r =>
            canvas.toBlob(r, 'image/jpeg', (qLow + qHigh) / 2)
        );
    }

        processBtn.onclick = async () => {
            if (!croppedImage) return;
            processBtn.disabled = true;
            processing.style.display = 'block';
            document.getElementById('resultCard').style.display = 'none';

            const w = +width.value;
            const h = +height.value;

            // For signatures, apply triple sharpen for maximum clarity
            const sharpenPasses = (photoType === 'signature') ? 3 : 2;

            const resizedCanvas = stepDownResize(croppedImage, w, h);
            const canvas = resizedCanvas;
            const ctx = canvas.getContext('2d');

          // âœ… ADAPTIVE SHARPEN: 2x for photos, 3x for signatures
            for (let i = 0; i < sharpenPasses; i++) {
                applyEdgeSharpen(ctx, w, h);
            }

            if (stampEnabled) {
                const name = stampName.value.trim().toUpperCase();
                let dateStr = '';
                if (stampDate.value) {
                    const d = new Date(stampDate.value);
                    dateStr = `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
                }

                const lines = [name, dateStr].filter(Boolean);
                if (lines.length) {
                    const fontBase = Math.max(8, Math.min(13, Math.round(h * 0.06)));
                    const lineHeight = Math.round(fontBase * 1.18);
                    const padding = Math.round(fontBase * 0.35);
                    const stripH = lines.length * lineHeight + padding * 2;

                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, h - stripH, w, stripH);
                    ctx.strokeStyle = '#cccccc';
                    ctx.strokeRect(0, h - stripH, w, stripH);

                    ctx.save();
                    ctx.translate(0.5, 0.5);
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    let y = h - stripH + padding + (lineHeight / 2);
                    lines.forEach(t => {
                        let fs = fontBase;
                        do {
                            ctx.font = `bold ${fs}px Tahoma, Arial, sans-serif`;
                            fs--;
                        } while (ctx.measureText(t).width > w - 8 && fs > 6);
                        ctx.fillText(t, w / 2, y);
                        y += lineHeight;
                    });
                    ctx.restore();
                }
            }

            let blob;
            if (targetKB === 30) {
                if (photoType === 'signature') {
                    // Signatures: aim for higher quality within 30KB
                    blob = await compressToTarget(canvas, 20, 30);
                } else {
                    blob = await compressToTarget(canvas, 25, 30);
                }
            } else {
                blob = await compressToTarget(canvas, 95, 100);
            }

            const url = URL.createObjectURL(blob);
            preview.src = url;
            download.href = url;
            const filePrefix = photoType === 'signature' ? 'psc-signature' : 'psc-photo';
            download.download = `${filePrefix}-${w}x${h}-${Math.round(blob.size / 1024)}kb.jpg`;
            meta.textContent = `Final size: ${Math.round(blob.size / 1024)} KB Â· ${w}Ã—${h}px Â· JPEG`;
            gtag('event', 'psc_photo_prepared', {
                file_size: Math.round(blob.size / 1024),
                dimensions: `${w}x${h}`,
                target_kb: targetKB,
                stamp_enabled: stampEnabled
            });

            processing.style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
            processBtn.disabled = false;
        };
        download.onclick = () => {
                gtag('event', 'psc_photo_downloaded', {
                    file_size: Math.round(preview.src ? parseInt(meta.textContent) : 0),
                    target_kb: targetKB
                });
            };
        </script>
    </script>

</body>

</html>